<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registro de Notas</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      background: #f5f5f5;
    }
    .sidebar {
      width: 220px;
      background: #fff;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      padding: 20px;
      height: 100vh;
      position: fixed;
    }
    .sidebar a {
      display: block;
      margin-bottom: 15px;
      text-decoration: none;
      color: #333;
      font-weight: bold;
    }
    .content {
      margin-left: 240px;
      padding: 20px;
      flex: 1;
    }
    .aluno-card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .numero {
      width: 40px;
      height: 40px;
      background: #3498db;
      color: #fff;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
    }
    .aluno-nome {
      font-size: 1.2em;
      font-weight: bold;
    }
    .campo {
      margin-top: 10px;
    }
    label {
      display: block;
      margin-top: 5px;
      font-size: 0.9em;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-top: 3px;
    }
    .btn-azul {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      margin-top: 10px;
      margin-right: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    .btn-azul:hover {
      background: #2980b9;
    }
    h1 {
      margin-bottom: 20px;
    }
    .nota-final {
      margin-top: 10px;
      font-weight: bold;
    }
    .apostila-status {
      margin-top: 5px;
      font-style: italic;
      color: #555;
    }
    /* Popup */
    .popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .popup-content img {
      width: 80px;
      margin-bottom: 20px;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

  <div class="sidebar">
    <a href="diario_de_classe_avaliacoes.html">Avaliações</a>
    <a href="diario_de_classe_fechamento.html">Fechamento</a>
    <a href="diario_de_classe_frequencia.html">Frequência</a>
    <a href="diario_de_classe_registro_de_aulas.html">Registro de Aulas</a>
    <a href="diario_de_classe_relatorios.html">Relatórios</a>
  </div>

  <div class="content">
    <h1>Registro de Notas</h1>

    <label for="materia">Selecione a matéria:</label>
    <select id="materia">
      <option>Kwamilogia</option>
      <option>Simulação Multiverso</option>
      <option>História dos Miraculous</option>
      <option>Matemática</option>
    </select>

    <div id="alunos-container"></div>
  </div>

  <!-- POPUP -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <img src="correto.png" alt="Correto">
      <p>Avaliação salva com sucesso!</p>
      <button class="btn-azul" onclick="fecharPopup()">OK</button>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCL2e1Zi-pzXQZ-02vQf6I8rYjbi5IzaRo",
    authDomain: "aula-miraculosa.firebaseapp.com",
    databaseURL: "https://aula-miraculosa-default-rtdb.firebaseio.com",
    projectId: "aula-miraculosa",
    storageBucket: "aula-miraculosa.appspot.com",
    messagingSenderId: "1067250456026",
    appId: "1:1067250456026:web:632e43e793155444035ce3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const container = document.getElementById('alunos-container');

  db.ref('Alunos').once('value').then(snapshot => {
    let numero = 1;
    snapshot.forEach(child => {
      const nome = child.key;
      const card = document.createElement('div');
      card.className = 'aluno-card';
      card.innerHTML = `
        <div>
          <span class="numero">${numero}</span>
          <span class="aluno-nome">${nome}</span>
        </div>
        <div class="campo">
          <label>Trabalhos Entregues (%)</label>
          <input type="number" min="0" max="100" id="trabalhos-${nome}">
        </div>
        <div class="campo">
          <label>Tarefas Realizadas (%)</label>
          <input type="number" min="0" max="100" id="tarefas-${nome}">
        </div>
        <div class="campo">
          <label>Notas na Prova (%)</label>
          <input type="number" min="0" max="100" id="provas-${nome}">
        </div>
        <div class="campo">
          <label>Notas da Apostila</label>
          <select id="apostila-${nome}" onchange="atualizarApostila('${nome}')">
            <option value="0">0 - Apostila Incompleta</option>
            <option value="1">1 - Metade da Apostila</option>
            <option value="2">2 - Apostila Completa</option>
          </select>
        </div>
        <div class="apostila-status" id="apostila-status-${nome}">Apostila: Incompleta</div>
        <div class="nota-final" id="nota-final-${nome}">Nota Final: 0%</div>
        <button class="btn-azul" onclick="calcularNota('${nome}')">Editar</button>
        <button class="btn-azul" onclick="salvarNota('${nome}', ${numero})">Salvar na Média</button>
      `;
      container.appendChild(card);
      numero++;
    });
  });

  function atualizarApostila(nome) {
    const ap = document.getElementById(`apostila-${nome}`).value;
    const status = {
      0: 'Apostila: Incompleta',
      1: 'Apostila: Metade da Apostila',
      2: 'Apostila: Completa'
    };
    document.getElementById(`apostila-status-${nome}`).innerText = status[ap];
  }

  function calcularNota(nome) {
    const t = Number(document.getElementById(`trabalhos-${nome}`).value) || 0;
    const ta = Number(document.getElementById(`tarefas-${nome}`).value) || 0;
    const p = Number(document.getElementById(`provas-${nome}`).value) || 0;
    const apEscala = Number(document.getElementById(`apostila-${nome}`).value);

    const apPorcentagem = apEscala === 0 ? 0 : apEscala === 1 ? 50 : 100;

    const notaFinal = ((t * 0.2) + (ta * 0.2) + (p * 0.3) + (apPorcentagem * 0.3)).toFixed(2);

    document.getElementById(`nota-final-${nome}`).innerText = `Nota Final: ${notaFinal}%`;
  }

  function salvarNota(nome, numero) {
    const materia = document.getElementById('materia').value;
    const t = Number(document.getElementById(`trabalhos-${nome}`).value) || 0;
    const ta = Number(document.getElementById(`tarefas-${nome}`).value) || 0;
    const p = Number(document.getElementById(`provas-${nome}`).value) || 0;
    const apEscala = Number(document.getElementById(`apostila-${nome}`).value);

    const apPorcentagem = apEscala === 0 ? 0 : apEscala === 1 ? 50 : 100;

    const notaFinal = ((t * 0.2) + (ta * 0.2) + (p * 0.3) + (apPorcentagem * 0.3)).toFixed(2);

    db.ref(`Alunos/${nome}/1 BIMESTRE/${materia}`).set({
      Trabalhos: t + '%',
      Tarefas: ta + '%',
      Provas: p + '%',
      Apostila: apEscala,
      NotaFinal: notaFinal + '%'
    }).then(() => {
      abrirPopup();
    }).catch(err => {
      console.error('Erro ao salvar:', err);
    });
  }

  function abrirPopup() {
    document.getElementById('popup').style.display = 'flex';
  }

  function fecharPopup() {
    document.getElementById('popup').style.display = 'none';
  }

  window.addEventListener('click', function(e) {
    const popup = document.getElementById('popup');
    if (e.target == popup) {
      fecharPopup();
    }
  });
</script>

</body>
</html>
